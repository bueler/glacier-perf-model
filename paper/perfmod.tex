\documentclass[twocolumn,letterpaper]{igs}
%\documentclass[twocolumn]{igs}  % A4 paper needs no option
%\documentclass[review,letterpaper]{igs}

\usepackage{verbatim,xspace,amsmath,amssymb,bm,multirow,dashbox}
\usepackage{tikz}
\usetikzlibrary{arrows}
\usepackage{igsnatbib,lineno}

\usepackage[kw]{pseudo}
\pseudoset{left-margin=0mm,topsep=5mm,idfont=\texttt}

\usepackage{hyperref}
\hypersetup{pdfauthor={Ed Bueler},
            pdfcreator={pdflatex},
            colorlinks=true,
            citecolor=purple,
            linkcolor=red,
            urlcolor=blue,
            }

% math macros
\newcommand\bb{\mathbf{b}}
\newcommand\bc{\mathbf{c}}
\newcommand\bbf{\mathbf{f}}
\newcommand\bg{\mathbf{g}}
\newcommand\bn{\mathbf{n}}
\newcommand\bq{\mathbf{q}}
\newcommand\bu{\mathbf{u}}
\newcommand\bv{\mathbf{v}}
\newcommand\bx{\mathbf{x}}
\newcommand\by{\mathbf{y}}

\newcommand\bA{\mathbf{A}}
\newcommand\bF{\mathbf{F}}
\newcommand\bH{\mathbf{H}}
\newcommand\bN{\mathbf{N}}
\newcommand\bQ{\mathbf{Q}}
\newcommand\bU{\mathbf{U}}
\newcommand\bV{\mathbf{V}}
\newcommand\bW{\mathbf{W}}
\newcommand\bX{\mathbf{X}}

\newcommand\bzero{\bm{0}}

\newcommand{\Div}{\nabla\cdot}
\newcommand\eps{\epsilon}
\newcommand{\grad}{\nabla}
\newcommand{\ip}[2]{\ensuremath{\left<#1,#2\right>}}
\newcommand\lam{\lambda}
\newcommand\lap{\triangle}
\newcommand\RR{\mathbb{R}}
\newcommand{\half}{\tfrac{1}{2}}

\newcommand{\Divx}{\nabla_\bx \cdot}
\newcommand{\gradx}{\nabla_\bx}

\newcommand{\rhoi}{\rho_{\text{i}}}
\newcommand{\pp}{{\text{p}}}
\newcommand{\qq}{{\text{q}}}
\newcommand{\rr}{{\text{r}}}

\newcommand{\mR}{R^{\bm{\oplus}}}
\newcommand{\iR}{R^{\bullet}}

\newcommand{\sold}{s_{\text{o}}}
\newcommand{\told}{t_{\text{o}}}

\newcommand{\byold}{\by_{\text{o}}}

\newcommand{\onecol}[1]{\includegraphics[width=86mm]{#1}}
\newcommand{\onecolless}[1]{\includegraphics[width=80mm]{#1}}
\newcommand{\onecolthin}[1]{\includegraphics[width=75mm]{#1}}

%\newcommand{\twocol}[1]{\includegraphics[width=178mm]{#1}}
\newcommand{\twocol}[1]{\includegraphics[width=165mm]{#1}}
\newcommand{\twocolless}[1]{\includegraphics[width=140mm]{#1}}

\newcommand{\ds}{\displaystyle}

\begin{document}

\title[Performance analysis of high-resolution ice sheet simulations]{Letter: Performance analysis of \\ high-resolution ice sheet simulations}

\abstract{High spatial resolution numerical ice sheet models, with horizontal mesh/grid resolutions of a few kilometers or less, compute evolving ice geometry and velocity fields using various stress-balance approximations and boundary conditions.  These models usually require many time steps, usually shorter than climate-coupling time scales, because ice thickness is updated following each velocity solution.  That is, practical performance in the high-resolution limit is degraded by the stability conditions imposed by such explicit time-stepping.  In this short note, regarding the shallow ice approximation and Stokes models as stress balance end members, we attempt to clarify numerical model performance by quantifying the simulation cost per model year in terms of the mesh resolution and number of degrees of freedom.  The performance of coming generations of implicit time-stepping numerical models is then assessed.  Our main result, Table \ref{tab:performancemodel}, emphasizes the key role played by solver performance in Stokes models.}

\author{Ed Bueler}

\affiliation{Dept.~Mathematics and Statistics, University of Alaska Fairbanks, USA \\
E-mail: \emph{\texttt{elbueler\@@alaska.edu}}}

%\keywords{}

\maketitle

\sectionsize

\section{Introduction}

Numerical ice sheet (glacier) models with evolving ice geometry are now in routine use for scientific questions such as quantification of future sea level rise from changes in the Antarctic \citep{Seroussietal2020} and Greenland \citep{Goelzeretal2020} ice sheets, interpretation of the paleoglacial record \citep{Weberetal2021}, and quantification of long-term glacial erosion \citep{SeguinotDelaney2021}, among other applications.  It is generally accepted that horizontal mesh (grid) cells must be smaller than about 10 km in order to generate valid results, but narrow outlet glacier flows suggest the need for finer resolution.  Whether using local mesh refinement \citep[for example]{Hoffmanetal2018} or not, resolutions of a few kilometers to one kilometer \citep{SeguinotDelaney2021} or less \citep{Aschwandenetal2019} are increasingly used at ice sheet scale.

Current-generation ice sheet models use a variety of stress balances, from the simplest shallow ice approximation (SIA), through ``hybrid'' \citep{Robinsonetal2022,Winkelmannetal2011} and higher-order balances, to the non-shallow and non-hydrostatic Stokes approximation.  With very few exceptions, however, current models alternate between solving the stress balance for velocity, using the geometry determined by the previous time step, and then updating the geometry using the last-computed velocity field.  Therefore ice thickness and surface elevation, which are functionally-equivalent variables for this purpose, are updated after the velocity is fixed.  This geometry-update operation, using the mass continuity or surface kinematical equations \citep{GreveBlatter2009}, enables interaction between the ice sheet and the surrounding climate.  Such climatic coupling occurs through surface mass balance, sub-shelf (basal) mass balance, and calving processes in particular.

These standard schemes implement \emph{explicit} time-stepping for the coupled mass and momentum system which describes the dynamical evolution of ice sheets.\footnote{Confusingly, various ``semi-implicit'' and even ``fully implicit'' designators appear in the literature for explicit schemes which use the velocity computed from the geometry at the previous time step \citep[for example]{Chengetal2017}.}  Now, at least for simpler partial differential equation problems, the conditional stability of explicit time-stepping schemes is well-understood \citep{LeVeque2007}.  The stability limitations of explicit SIA models have also been understood for some time \citep{HindmarshPayne1996}, but recent studies have focussed on the time-step limits of hybrid, higher-order, and Stokes dynamics models \citep{Chengetal2017,Robinsonetal2022}, or on lengthening the steps \citep{LofgrenAhlkronaHelanow2021}.

However, actual \emph{implicit} time-stepping should also be considered.  Here the velocity and geometry are updated simultaneously by solving a coupled mass-momentum problem.  While implicit time-stepping always requires the solution of systems of equations at each step \citep{LeVeque2007}, for ice sheets an implicit step must simultaneously compute the velocity and the \emph{domain on which the velocity is defined}.  The problem is of free-boundary type, both in map-plane (horizontal) \citep{SchoofHewitt2013} and (easily-resolved) vertical directions.

A successful implicit strategy has been demonstrated at high-resolution in the simplest frozen-base, isothermal SIA case \citep{Bueler2016}.  The same reference shows how the steady-state problem \citep[see][for example]{JouvetBueler2012} can often be solved; observe that steady-state solutions correspond to an implicit time step of infinite duration.  The corresponding problem for the Stokes equations has not, to the author's knowledge, yet been attempted.  However, important early work applying a semi-implicit time step using Stokes dynamics \citep{WirbelJarosch2020} to solve for a free boundary illuminates some of the techniques and difficulties needed to make such a strategy work for a membrane-stress-resolving balance.

This is the complicated context in which the current note relates time-stepping and stress-balance choices to computational effort.  While the author expects that time-stepping ice sheet models will eventually become faster when implicit time-stepping is applied, along with advanced solver techniques like multigrid \citep{Briggsetal2000}, this belief should be inspected quantitatively to the extent possible.  A simplified performance (computational effort) analysis can expose the most important considerations and trade-offs.


\section{Mass continuity equation}

The reader is assumed to have access to the SIA and Stokes stress-balance equations \citep{GreveBlatter2009,SchoofHewitt2013}.  These (continuum) models are regarded here as end members of current-usage stress-balance approximations \citep{Robinsonetal2022}.

Familiarity with the mass continuity and surface kinematical equations \citep{GreveBlatter2009} is also assumed.  However, before presenting a performance analysis, the form of the mass continuity equation must be examined.  For an incompressible ice sheet with thickness $H(t,\bx)$, vertically-averaged velocity $\bu(t,\bx)$, and climatic-basal mass balance $a(t,\bx)$, this equation says
\begin{equation}
\frac{\partial H}{\partial t} + \Divx \left(\bu H\right) = a, \label{eq:masscontinuity}
\end{equation}
where $\bx=(x,y)$ denotes horizontal coordinates.

Equation \eqref{eq:masscontinuity} suggests that ice sheets change geometry in an essentially advective manner, but this appearance is deceiving, or at least over-simplified, especially regarding the growth of numerical instabilities.  This is because ice flows dominantly downhill.  Indeed, ice sheet flow has no characteristic curves, as would a true advection, because the velocity $\bu$ actually depends on the gradient of thickness through the stress balance.  Thus, as addressed by linearized analysis \citep{Chengetal2017,Robinsonetal2022}, when thickness perturbations grow unstably under explicit time-stepping, i.e.~with too large a step, they do so by a mix of advective and diffusive mechanisms.

Let $s(t,\bx)=H(t,\bx)+b(\bx)$ denote the surface elevation for bed elevation $b(\bx)$.  If a numerical thickness perturbation grows then the velocity $\bu$ often responds by increasing in a direction close to downhill ($-\gradx s$), a direction often correlated to $-\gradx H$.  In membrane-stress-resolving models like Stokes this happens through the non-local solution of the stress balance, but the gravitational driving stress is always along $\gradx s$.  Equation \eqref{eq:masscontinuity} therefore has velocity $\bu$ which is really a non-local function ``$\bu(H,\grad_x s)$'', though a stress balance solution is required to evaluate this function.  A numerical instability occurs when the ice thickness under/over-shoots its correct (i.e.~continuum) value because the numerical velocity response is too strong.

\newcommand{\nn}{\text{n}}
The mass continuity equation is not wholely diffusive for Stokes dynamics, but the diffusive nature dominates in the small-parameter limit which generates the SIA.  In the isothermal case we see the following, revised mass continuity equation:
\begin{equation}
\frac{\partial H}{\partial t} = \Divx \left(d\, \gradx s \right) + a. \label{eq:siamasscontinuity}
\end{equation}
Here $d = C H^{\nn+2} |\gradx s|^{\nn-1}$ is the nonlinear diffusivity and $C$ is a positive constant.\footnote{In detail, $C = 2 A (\rho g)^\nn/(\nn+2)$ where $A$ is the (isothermal) ice softness, $\rho$ is the ice density, $g$ is gravity, and $\nn$ is the Glen exponent in the flow law \citep{GreveBlatter2009}.  Typically $\nn\approx 3$.}

Equation \eqref{eq:siamasscontinuity} does not hold for Stokes or other membrane-stress-resolving dynamics.  However, the same diffusivity $d$, an essentially geometric quantity, can be computed.  For grounded ice sheets one observes that large values of $d$ often indicate locations of unstable mode growth if explicit time-steps are chosen too large.


\begin{table*}[ht]
{\normalsize
\begin{tabular}{cll}
\emph{name} & \emph{meaning} & \emph{units} \\ \hline
$\alpha$    & one fixed-geometry Stokes velocity solution requires $O(n^{1+\alpha})${\large \strut} work\\
$\beta$     & one implicit SIA geometry-update requires $O(n^{1+\beta})$ work \\
$\gamma$    & one implicit Stokes geometry/velocity solution requires $O(n^{1+\gamma})$ work \\
$D$         & representative geometric (SIA) diffusivity of an ice sheet & $\text{km}^2 \text{a}^{-1}$ \\
$L$         & width of simulation domain & km \\
$n$         & degrees of freedom: number of nodes in the horizontal mesh \\
$q$         & time steps per model year needed to resolve modeled climate interactions & $\text{a}^{-1}$ \\
$\Delta t$  & length of time step in model years & a \\
$U$         & representative horizontal ice velocity & $\text{km}\,\text{a}^{-1}$ \\
$\Delta x$  & representative width (diameter) of map-plane mesh cells & km
\end{tabular}
}
\caption{Parameters for performance analysis; $\alpha,\beta,\gamma,n$ are pure numbers.}
\label{tab:notation}
\end{table*}


\section{Performance analysis}

We parameterize simulation performance using either $\Delta x$, the representative horizontal mesh/grid cell diameter, i.e.~the resolution, or $n$, the number of nodes or vertices in the horizontal mesh or grid.  The model domain is of (horizontal) width $L$ so $\Delta x = O(L n^{-1/2})$; there are $O(\sqrt{n})$ mesh cells in each horizontal dimension.\footnote{In flow-line models $\Delta x = O(L n^{-1})$, but our analysis focusses on spatially-3D models with map-plane horizontal meshes or grids.}  Table \ref{tab:notation} lists the parameters used in our analysis.  Big-O notation applies only in the high resolution limit where $\Delta x \to 0$ and $n\to \infty$.  

A standard numerical ice sheet model uses $n$ ice thickness or surface elevation variables, the number of \emph{degrees of freedom}, and it requires $O(n)$ memory to store the instantaneous model state, including thermodynamical variables for example, if we assume that the vertical mesh/grid has an \emph{a priori} bounded resolution.\footnote{This bounded-vertical-nodes assumption reflects common usage \citep[for example]{Aschwandenetal2019,Brinkerhoffetal2017,Hoffmanetal2018}.  However, the \cite{IsaacStadlerGhattas2015} Stokes and \cite{BrownSmithAhmadia2013} higher-order multigrid solvers use 3D refinement, though with certain modifications regarding vertical refinement.}  The amount of fast memory needed by a running ice sheet simulation is also $O(n)$ if prior states are discarded or transferred to storage.  Ice sheet models also have $O(n)$ velocity variables, but these are not state variables because a very-viscous stress balance can recompute velocity as a function of (true) state variables.
 
Ice sheet models involve climate interactions (coupling), especially via surface mass balance, on time scales which are dominated by an annual cycle and certain longer scales.  We define $q$ as the number of ice-dynamical time steps per year needed to capture this coupling.  Some typical values $q=0.1 \,\text{a}^{-1}, 1 \,\text{a}^{-1}, 12 \,\text{a}^{-1}$ correspond to decadal, yearly, and monthly coupling frequency, respectively.  Note that energy balance and degree-day schemes for computing surface mass balance generally have much shorter time scales, but here $q$ only describes the frequency on which ice geometry is updated from an ice velocity solution and the latest surface mass balance values.

As already noted, current-technology ice sheet models use explicit time-stepping which is only conditionally stable \citep{LeVeque2007}.  For the spatial resolutions used in present-day scientific applications, we observe that maintenance of explicit time-stepping stability requires time steps substantially shorter than $1/q$ model years.  For an explicit SIA model the well-known stability restriction is $\Delta t < O(D^{-1} \Delta x^2)$ \citep{Bueleretal2005,HindmarshPayne1996} where $D$ is a representative diffusivity value from the diffusivity formula in equation \eqref{eq:siamasscontinuity}.

For Stokes dynamics the stability of explicit time-stepping is largely unexplored in any precise sense, but we propose that an advective restriction $\Delta t < O(U^{-1} \Delta x)$, for some representative horizontal velocity scale $U$, computed from simulated ice velocities, represents the \emph{optimistic} paradigm.  The corresponding \emph{pessimistic} paradigm enforces $\Delta t < O(D^{-1} \Delta x^2)$, using diagnostic diffusivity values computed in the SIA manner.

Explicit time-stepping with hybrid and higher-order schemes is better-studied than for Stokes dynamics, especially over horizontal resolutions relevant to whole ice sheets.  Some hybrid schemes apply the pessimistic time step as an adaptive restriction \citep{Winkelmannetal2011}.  The optimistic time step is supported for a certain higher-order DIVA scheme \citep[see equation (52)]{Robinsonetal2022}, but practical Greenland simulations in the same work actually suggest $\Delta t = O(\Delta x^{1.6})$ (Figure 3(a)).

Unconditionally-stable implicit schemes also have a maximum time step restriction, namely $1/q$ itself.  This restriction reflects the simulation purpose and not the maintenance of stability.  Thus, for an implicit scheme the frequency of climate coupling determines the time-stepping simulation cost, through the need to solve the coupled mass/momentum equations with frequency $q$.

Regardless of time-stepping design, for each explicit time step the velocity (or velocity/pressure) solution of the stress balance equations requires effort, namely the solution of (spatial) partial differential equations.  For the Stokes model we suppose one such solution requires $O(n^{1+\alpha})$ work, which we describe the the number floating point operations in our simple performance analysis.

Of course, the power $\alpha$ depends on the design of the stress balance solver.  A direct linear algebra Stokes solver implementation might yield $\alpha=3$, or $\alpha \approx 2$ when exploiting sparsity, but a multigrid method, such as the algebraic multigrid \citep{Trottenbergetal2001} solver by \cite{IsaacStadlerGhattas2015}, reduces $\alpha$.  Their Antarctic ice sheet results show Newton-Krylov iterations \citep{Bueler2021} growing only slowly under mesh refinement, suggesting perhaps $\alpha\approx 0.2$ \citep[see Table 8.1]{IsaacStadlerGhattas2015}.
% from Table 8.1:
% [7*66 10*75 11*90] = [462 750 990]
%>> polyfit(log([1 8 64]),log([462 750 990]),1)
%ans = 0.18326   6.17004
A geometric multigrid method applied to the higher-order stress balance equations \citep{BrownSmithAhmadia2013} suggests $\alpha$ also close to zero for certain simplified geometries.\footnote{The \cite{IsaacStadlerGhattas2015} and \cite{BrownSmithAhmadia2013} results also show good parallel scaling, something not considered in our simplified analysis.}  At the even easier end, the isothermal SIA velocity computation is a trivialization of the Stokes problem in which the vertically-averaged velocity at each node is computed by a pointwise formula, $O(1)$ work; a velocity solution requires only $O(n)$ work ($\alpha=0$).

When analyzing solver scaling in this simple manner, one must be aware that the constant in $O(n^{1+\alpha})$ can be very large.  Furthermore it will vary greatly based on solver design.

Regardless of the stress balance source, an explicit time-stepping scheme applies the mass continuity equation to update the ice thickness using $O(n)$ work.  That is, once the velocity is computed for the geometry from the previous time step, old thickness values are replaced by new ones by a formula needing only $O(1)$ work per mesh node.

\newcommand{\oo}[1]{\displaystyle O\left(#1\right)}
\setlength{\tabcolsep}{5pt}
\renewcommand{\arraystretch}{1.5}
\begin{table*}[ht]
{\normalsize
\begin{tabular}{llll}
\emph{time-stepping} & \emph{dynamics} & \emph{flops per model year} & \emph{pessimistic} \\ \hline
explicit & SIA    & $\oo{\frac{D\, L^2}{\Delta x^4}} = \oo{\frac{D\, n^2}{L^2}}${\Huge \strut} \\
explicit & Stokes & $\oo{\frac{U L^{2+2\alpha}}{\Delta x^{3+2\alpha}}} = \oo{\frac{U n^{1.5+\alpha}}{L}}${\Huge \strut}\phantom{x} & $\oo{\frac{D\, L^{2+2\alpha}}{\Delta x^{4+2\alpha}}} = \oo{\frac{D\,n^{2+\alpha}}{L^2}}$ \\
implicit & SIA    & $\oo{\frac{q\, L^{2+2\beta}}{\Delta x^{2+2\beta}}} = \oo{q\, n^{1+\beta}}${\Huge \strut} \\
implicit & Stokes & $\oo{\frac{q\, L^{2+2\gamma}}{\Delta x^{2+2\gamma}}} = \oo{q\, n^{1+\gamma}}${\Huge \strut}
\end{tabular}
}
\caption{Asymptotic scaling of computational work, measured by floating point operations per model year, for map-plane (2D) time-stepping numerical ice sheet simulations, in the high resolution limit where $\Delta x\to 0$ and $n\to\infty$.  See Table \ref{tab:notation} for notation.}
\label{tab:performancemodel}
\end{table*}

Now suppose that a numerical model takes time steps of $\Delta t$ model years, equivalently $\Delta t^{-1}$ time steps per model year.  Recalling the scaling of $\Delta x$ with $n$, namely that $\Delta x = O(L n^{-1/2})$, equivalently $n=O(L^2 \Delta x^{-2})$, for explicit schemes we may write the stability restriction as a required number of time-steps per model year in order to maintain stability, namely
% $\Delta t < O(D^{-1} \Delta x^2)$
\begin{equation}
\frac{1}{\Delta t} > \oo{\frac{D}{\Delta x^2}} = \oo{\frac{D n}{L^2}} \label{eq:explicitsiarequired}
\end{equation}
in the SIA and pessimistic-Stokes cases.  In the optimistic-Stokes case the estimate becomes
% $\Delta t < O(U^{-1} \Delta x)$
\begin{equation}
\frac{1}{\Delta t} > \oo{\frac{U}{\Delta x}} = \oo{\frac{U n^{1/2}}{L}}. \label{eq:explicitoptstokesrequired}
\end{equation}

The number of time steps per model year is multiplied by the per-step computational cost to give a work estimate for each model year in a simulation.  The results so far are shown in the ``explicit'' rows of Table \ref{tab:performancemodel}.

For unconditionally-stable implicit methods, however, $\Delta t$ does not scale with grid resolution; it has fixed value $\Delta t = 1/q$ determined by the need to resolve climatic interactions.  On the other hand, the per-step expense is much greater because nontrivial equations, indeed a free-boundary problem, must be solved.  FIXME for the unconditionally-stable implicit geometric-update scheme in the SIA, as demonstrated by \cite{Bueler2016}, $O(n^{1+\beta})$ work; it is not multigrid; indeed the steady-state SIA solver in \cite{Bueler2016} allows $\Delta t=+\infty$, with $\Delta t = 100 \,\text{a}$ as a recovery strategy in the case of solver non-convergence

For an implicit Stokes simulation the geometry/velocity solve is assumed to be, in the absense of constraining research, $O(n^{1+\gamma})$ for some $\gamma>0$ to be determined.  The nMCD method proposed in [Bueler 2022] is expensive but multigrid, so it may turn out that $\gamma$ is small.

FIXME emphasize the estimate reported in Table \ref{tab:performancemodel} must be multiplied by a potentially very large scheme-dependent constant.


\section{Discussion and Conclusion}

FIXME from Table \ref{tab:performancemodel} we see for explicit SIA that work scales as $\Delta x^{-4}$ for a given problem with fixed $D$ and $L$; because work per step scales as $\Delta x^{-2}$ but number of steps also scales as $\Delta x^{-2}$; explicit time-stepping Stokes is even worse under the pessimistic model; if solver only achieves $\alpha=2$ then work scales like horrific $\Delta x^{-8}$ (or $\Delta x^{-7}$ if optimistic about time-stepping stability); even for explicit time stepping the implementation burden of multigrid should pay off

FIXME one can also fix resolution (fix $\Delta x$) and look at the expense of larger ice sheets ($L\to \infty$) to see why Stokes is difficult: scales as $L^{2+2\alpha}$ for optimistic and pessimistic cases; again want $\alpha$ is small

FIXME The real promise of multigrid methods for the implicit, coupled geometry-update plus velocity solution problems is to make $\beta,\gamma$ seriously smaller.  Specifically $\gamma < 1$ might be regarded as the goal of the next few decades of work on Stokes models.  However, this aspiration is long-term because work is barely started on it.

%         References
\bibliography{perfmod}
\bibliographystyle{igs}

\end{document}
